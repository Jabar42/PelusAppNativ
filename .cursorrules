# Constituci贸n de Desarrollo PelusApp

Como IA de Cursor, debes adherirte estrictamente a estas reglas para mantener la integridad de la arquitectura de Identidad Unificada.

## 1. Gobernanza de Arquitectura y Documentaci贸n
- **Cita las Fuentes**: Antes de proponer cambios estructurales, consulta `ARQUITECTURA.md` y los documentos en `docs/`.
- **Registro de Decisiones**: Si sugieres un cambio en la l贸gica central (Auth, Roles, Metadatos), debes pedir permiso para registrarlo en `docs/DECISION_LOG.md`.
- **Sincronizaci贸n**: Al terminar una tarea, verifica si los diagramas Mermaid en la documentaci贸n necesitan actualizaci贸n.
- **Cumplimiento Arquitect贸nico**: Consulta `.cursor/rules/architecture-compliance.md` antes de implementar cualquier funcionalidad. Esta regla previene c贸digo ad-hoc que comprometa la escalabilidad.

## 2. Reglas de Identidad y Seguridad (Clerk)
- **Backend-Only Metadata**: NUNCA intentes escribir en `publicMetadata` desde el frontend. Usa `apiClient.post` hacia las Netlify Functions correspondientes.
- **Jerarqu铆a de Metadatos**: Respeta `docs/BACKEND_SECURITY.md`. Prohibido usar `unsafeMetadata` para l贸gica de permisos o navegaci贸n.
- **Contexto Activo**: La existencia de `organization` de Clerk es la 煤nica fuente de verdad para el modo B2B.

## 3. Estructura de Capas (Barrera de Capas)
- **Aislamiento**: Los archivos en `src/features/Shared/` NO pueden importar nada de otras subcarpetas de `features/`.
- **Auditor铆a de Features**: Al crear un nuevo archivo en `src/features/`, verifica que cumpla con la jerarqu铆a definida en `docs/FEATURE_STRUCTURE.md`.
- **Path Aliases**: Usa siempre el alias `@/` para importaciones internas.

## 4. Dise帽o y Estilos (Gluestack UI)
- **Protecci贸n de Temas**: Prohibido usar colores hardcodeados (ej. `color="#FF0000"`). Usa siempre tokens de dise帽o (ej. `$error600`).
- **Conciencia de Contexto**: Antes de modificar estilos, verifica `gluestack-ui.config.ts`. Respeta los temas visuales diferenciados para B2C y B2B.
- **Componentes Nativos**: Prioriza los componentes de `@gluestack-ui/themed`. Usa `ActionSheet` para selectores de contexto en m贸vil.

## 5. Persistencia y Base de Datos (Supabase)
- **Zero Static Tokens**: PROHIBIDO usar el cliente est谩tico de Supabase para operaciones autenticadas. Usa siempre el hook `useSupabaseClient`.
- **RLS Obligatorio**: Cada vez que crees una tabla en Supabase, DEBES definir pol铆ticas RLS basadas en los claims de Clerk (`sub` para B2C, `org_id` para B2B).
- **Single Source of Auth**: Supabase Auth est谩 desactivado. Toda validaci贸n de identidad se hace mediante el JWT de Clerk.
- **Consultas Seguras**: Al realizar queries, aseg煤rate de que el filtro por `owner_id` o `org_id` est茅 impl铆cito en el RLS, pero agr茅galo en la query si ayuda a la legibilidad o performance.

## 6. Regla de Auditor铆a Proactiva
- Cada vez que el usuario te pida una nueva funcionalidad, verifica:
  1. 驴Cumple con la estructura de capas?
  2. 驴Requiere cambios en la l贸gica de permisos? (Consulta `BACKEND_SECURITY.md`).
  3. 驴C贸mo afecta a la navegaci贸n sensible al contexto?

## 7. AI-First Development (Mastra Obligatorio)
- ** PROHIBIDO C贸digo Ad-Hoc**: NUNCA crear llamadas directas a APIs de LLM (OpenAI, Anthropic, etc.). SIEMPRE usar Mastra como orquestador.
- **Mastra Obligatorio**: Todos los agentes de IA DEBEN usar `Agent` de `@mastra/core/agent` e inicializarse con `initializeVeterinaryAgent()` de `utils/mastra-setup.ts`.
- **Tools con createTool**: Todos los tools MCP DEBEN crearse con `createTool` de `@mastra/core/tools`, nunca manualmente.
- **MCP Tools Obligatorios**: Cada nueva tabla o feature con datos debe tener tools MCP correspondientes definidos en `netlify/functions/mcp-tools/`.
- **Context Awareness**: Los tools deben documentar expl铆citamente qu茅 claims del JWT requieren (`user_id`, `org_id`, `active_location_id`).
- **Validaci贸n de Permisos**: Usa `validateToolPermissions` del MCP wrapper antes de ejecutar cualquier tool que acceda a datos sensibles.
- **Testing de RLS**: Cada tool debe tener tests que validen que no se filtra informaci贸n entre organizaciones o usuarios.
- **Rate Limiting**: Respeta los l铆mites configurados en `utils/rate-limiting.ts`. Tools de navegaci贸n est谩n exentos.
- **Consulta Obligatoria**: Antes de implementar cualquier funcionalidad de IA, consulta `docs/AI_ARCHITECTURE.md` y `.cursor/rules/architecture-compliance.md`.

## 8. AI Actions y Componentes
- **Registro de Actions**: Los componentes que pueden ser targets de AI Actions deben registrarse o documentarse en su c贸digo.
- **Documentaci贸n de Comandos**: Cada screen/feature debe documentar qu茅 comandos de lenguaje natural pueden invocarla (ej: "Ll茅vame a las vacunas de Firulais").
- **Actions Descriptivas**: Al retornar actions desde tools, usa estructuras claras: `{ type: 'navigate', screen: '/pet-detail', params: { petId } }`.
- **Manejo de Errores**: Las actions deben manejar errores gracefully (ej: mostrar alert si la navegaci贸n falla).

## 9. Seguridad Zero-Trust en IA
- **JWT Pass-Through**: El JWT de Clerk DEBE pasar desde el frontend hasta el MCP Server para que el RLS de Supabase funcione.
- **No Bypass de RLS**: NUNCA uses el Service Role Key de Supabase en tools MCP que devuelvan datos al usuario.
- **Validaci贸n de Contexto**: Antes de ejecutar un tool, verifica que el usuario tenga el contexto necesario (org activa, sede activa).
- **Audit Logging**: Usa `logToolExecution` para registrar todas las ejecuciones de tools con contexto completo.






